local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local plr = Players.LocalPlayer
local cam = workspace.CurrentCamera

local hum, hrp, char
local isHiding = false
local lastcf = nil
local isCharacterReady = false

local function setupCharacter(character)
	isCharacterReady = false
	char = character
	hum = char:WaitForChild("Humanoid")
	hrp = char:WaitForChild("HumanoidRootPart")

	hum.Died:Connect(function()
		isHiding = false
		lastcf = nil
		isCharacterReady = false
		cam.CameraType = Enum.CameraType.Custom
		cam.CameraSubject = hum
	end)

	cam.CameraSubject = hum
	cam.CameraType = Enum.CameraType.Custom
	isCharacterReady = true
end

if plr.Character then
	setupCharacter(plr.Character)
end
plr.CharacterAdded:Connect(setupCharacter)

local function startHiding()
	if isHiding or not isCharacterReady or not hrp then return end
	isHiding = true
	lastcf = hrp.CFrame
	cam.CameraType = Enum.CameraType.Scriptable
	cam.CFrame = cam.CFrame

	RunService:BindToRenderStep("HidePlayer", Enum.RenderPriority.Camera.Value + 1, function()
		if not isHiding or not hrp then return end
		hrp.Anchored = true
		hrp.CFrame = CFrame.new(0, -300, 0)
	end)
end

local function stopHiding()
	if not isHiding or not isCharacterReady or not hrp then return end
	isHiding = false
	RunService:UnbindFromRenderStep("HidePlayer")
	hrp.Anchored = false
	if lastcf then
		hrp.CFrame = lastcf
	end
	cam.CameraType = Enum.CameraType.Custom
	cam.CameraSubject = hum
end

UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.E then
		startHiding()
	end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.E then
		stopHiding()
	end
end)
