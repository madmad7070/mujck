local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local plr = Players.LocalPlayer
local cam = workspace.CurrentCamera

local hum, hrp, char
local isHiding = false
local lastcf = nil


local function onDied()
	isHiding = false
	lastcf = nil
	cam.CameraType = Enum.CameraType.Custom
	if hum then
		cam.CameraSubject = hum
	end
end


local function onCharacterAdded(character)
	char = character
	hum = char:WaitForChild("Humanoid")
	hrp = char:WaitForChild("HumanoidRootPart")

	hum.Died:Connect(onDied)

	cam.CameraSubject = hum
	cam.CameraType = Enum.CameraType.Custom
end


if plr.Character then
	onCharacterAdded(plr.Character)
end
plr.CharacterAdded:Connect(onCharacterAdded)


local function startHiding()
	if isHiding or not hrp then return end
	isHiding = true
	lastcf = hrp.CFrame or CFrame.new(0, 5, 0)
	cam.CameraType = Enum.CameraType.Scriptable
	cam.CFrame = cam.CFrame -- 현재 카메라 고정

	while isHiding do
		if not hrp then break end
		hrp.CFrame = CFrame.new(0, -300, 0)
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero
		task.wait(0.03)
	end
end


local function stopHiding()
	if not isHiding or not hrp then return end
	isHiding = false
	if lastcf then
		hrp.CFrame = lastcf
	end
	cam.CameraType = Enum.CameraType.Custom
	if hum then
		cam.CameraSubject = hum
	end
end


UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.E then
		startHiding()
	end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.E then
		stopHiding()
	end
end)
